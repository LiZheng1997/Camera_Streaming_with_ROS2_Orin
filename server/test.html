<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebRTC + G29 + 3D Shuttle (Adaptive)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  /* 统一四个相机 tile 的尺寸，自适应：最小280px，常规占视口宽度的30%，最大540px */
  --tile: clamp(280px, 30vw, 540px);
  --center-scale: 0.75; /* 中间车辆稍小一点 */
}

*{margin:0;padding:0;box-sizing:border-box;}
body{
  background:linear-gradient(135deg,#0a0e27 0%,#1a1e35 100%);
  color:white;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  min-height:100vh;display:flex;flex-direction:column;align-items:center;
}
.header{padding:18px 12px;text-align:center;}
h1{color:#00ff88;text-shadow:0 0 15px rgba(0,255,136,0.4);font-size:clamp(20px,2.2vw,28px);}
.subtitle{color:#9aa; font-size:clamp(12px,1.2vw,14px);}
.hidden{display:none;}

/* —— 校准卡片 —— */
.control-panel{
  margin-top:20px;width:min(92vw,480px);text-align:center;
  background:rgba(255,255,255,0.05);
  padding:18px;border-radius:12px;
  border:1px solid rgba(255,255,255,0.12);
  box-shadow:0 6px 24px rgba(0,0,0,0.20);
}
.control-panel h3{color:#00ff88;margin-bottom:8px;}
.bar-bg{background:rgba(255,255,255,0.12);border-radius:6px;margin:6px 0;height:10px;}
.bar{height:10px;background:#00ff88;border-radius:6px;transition:width 0.05s linear;}
button{
  margin:6px 6px;padding:9px 16px;border:none;border-radius:8px;cursor:pointer;
  background:rgba(255,255,255,0.1);color:#fff;backdrop-filter:blur(6px);
}
button:hover{background:#00ff88;color:#000;}
#statusMsg{margin-top:10px;color:#bbb;}

/* —— 主布局：用 3x3 网格居中排布 —— */
#mainContainer{
  width:100%;
  display:grid;
  place-items:center;         /* 网格单元内容居中 */
  grid-template-columns: 1fr auto 1fr;
  grid-template-rows:    1fr auto 1fr;
  gap:min(1.4vw,16px);
  padding: min(2vw,20px);
}

/* 四个相机和中间 3D 块都放一个 .slot 里，slot 负责居中，内部 .tile 负责统一尺寸 */
.slot{display:flex;align-items:center;justify-content:center;}

.tile{
  width:var(--tile);
  aspect-ratio:16/9;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:12px; overflow:hidden;
  box-shadow:0 6px 24px rgba(0,0,0,0.20);
  display:flex;flex-direction:column;
}
.tile-header{
  padding:6px 10px;background:rgba(0,0,0,0.45);
  border-bottom:1px solid #00ff88;font-size:0.95em;
}
.tile-body{flex:1;display:flex;align-items:center;justify-content:center;background:#000;}

video{width:100%;height:100%;object-fit:contain;background:#000;}

/* 中间 three.js */
#three-container{
  width:calc(var(--tile)*var(--center-scale));
  height:calc(var(--tile)*var(--center-scale)*0.6);  /* 更扁一点，突出四路视频 */
  background:rgba(10,14,39,0.6);
  border:1px dashed rgba(0,255,136,0.25);
  border-radius:12px; overflow:hidden;
}

/* —— 参数面板（可收起） —— */
#settings{
  margin:12px auto; width:min(92vw,960px); 
  background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12);
  border-radius:12px; padding:12px;
}
#settings h4{margin:0 0 8px 0; color:#00ff88;}
.settings-grid{
  display:grid; gap:10px;
  grid-template-columns: repeat(6, minmax(120px, 1fr));
}
.settings-grid label{font-size:12px;color:#cfd;}
.settings-grid input[type="color"], .settings-grid input[type="number"], .settings-grid select{
  width:100%; padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.15);
  background:rgba(0,0,0,0.35); color:#fff;
}
@media (max-width: 1100px){
  .settings-grid{ grid-template-columns: repeat(3, minmax(120px, 1fr)); }
}
@media (max-width: 600px){
  .settings-grid{ grid-template-columns: repeat(2, minmax(120px, 1fr)); }
}

/* —— 自适应整体外边距 —— */
.container-pad { padding: min(2vw, 20px); }
</style>
</head>
<body>
  <div class="header">
    <h1>🛰️ WebRTC + Logitech G29 + 3D Shuttle</h1>
    <p class="subtitle">四路相机等尺寸 | 中心 3D 车辆稍小 | 自适应布局</p>
  </div>

  <!-- 🎮 校准面板 -->
  <div id="calibrationPanel" class="control-panel">
    <h3>🎮 Logitech G29 校准</h3>
    <div id="g29Status">等待连接 G29 ...（按任意按键唤醒）</div>
    <div id="calibMsg" style="margin-top:4px;">左右打满方向、油门刹车踩到底，然后点开始</div>
    <div style="margin-top:8px;">
      <button onclick="startCalibration()">开始校准</button>
      <button onclick="confirmCalibration()">确认并进入监控</button>
      <button onclick="resetCalibration()">重置</button>
    </div>
    <div style="margin-top:12px;text-align:left;">
      <div>Steering <span id="steerVal">0</span></div>
      <div class="bar-bg"><div id="steerBar" class="bar" style="width:50%"></div></div>
      <div>Throttle <span id="throttleVal">0</span></div>
      <div class="bar-bg"><div id="throttleBar" class="bar" style="width:0%"></div></div>
      <div>Brake <span id="brakeVal">0</span></div>
      <div class="bar-bg"><div id="brakeBar" class="bar" style="width:0%"></div></div>
    </div>
    <p id="statusMsg">正在连接控制服务器...</p>
  </div>

  <!-- ⚙️ 车辆参数设置（进入监控后可用） -->
  <div id="settings" class="hidden">
    <h4>⚙️ 车辆参数设置</h4>
    <div class="settings-grid">
      <div><label>车身颜色</label><input type="color" id="bodyColor" value="#ffffff"></div>
      <div><label>饰条颜色</label><input type="color" id="trimColor" value="#00ff88"></div>
      <div><label>轮距 Track (m)</label><input type="number" id="track" step="0.1" value="1.6"></div>
      <div><label>轴距 Wheelbase (m)</label><input type="number" id="wheelbase" step="0.1" value="2.6"></div>
      <div><label>最大转角 (°)</label><input type="number" id="maxSteerDeg" step="1" value="30"></div>
      <div>
        <label>大灯模式</label>
        <select id="beamMode">
          <option value="narrow" selected>窄光束</option>
          <option value="wide">宽光束</option>
        </select>
      </div>
    </div>
  </div>

  <!-- 🖼 主布局（四路相机等尺寸 + 中间 3D 稍小） -->
  <div id="mainContainer" class="hidden container-pad">
    <!-- 顶部：Front -->
    <div class="slot" style="grid-row:1; grid-column:2;">
      <div class="tile">
        <div class="tile-header">Front Camera</div>
        <div class="tile-body"><video id="video-4" autoplay playsinline muted></video></div>
      </div>
    </div>

    <!-- 中间左：FrontLeft -->
    <div class="slot" style="grid-row:2; grid-column:1;">
      <div class="tile">
        <div class="tile-header">FrontLeft Camera</div>
        <div class="tile-body"><video id="video-1" autoplay playsinline muted></video></div>
      </div>
    </div>

    <!-- 中间：Three.js Shuttle Bus（尺寸稍小） -->
    <div class="slot" style="grid-row:2; grid-column:2;">
      <div id="three-container"></div>
    </div>

    <!-- 中间右：FrontRight -->
    <div class="slot" style="grid-row:2; grid-column:3;">
      <div class="tile">
        <div class="tile-header">FrontRight Camera</div>
        <div class="tile-body"><video id="video-3" autoplay playsinline muted></video></div>
      </div>
    </div>

    <!-- 底部：Rear -->
    <div class="slot" style="grid-row:3; grid-column:2;">
      <div class="tile">
        <div class="tile-header">Rear Camera</div>
        <div class="tile-body"><video id="video-2" autoplay playsinline muted></video></div>
      </div>
    </div>
  </div>

<!-- Three.js（非模块版，当前兼容；未来可换 ESM） -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

<script>
/* ====================== G29 控制与校准 ====================== */
let gamepadIndex=null, calibActive=false, calibrated=false;
let calibData={steerMin:1,steerMax:-1,throttleMin:1,throttleMax:-1,brakeMin:1,brakeMax:-1};
let smooth={linear:0,angular:0};
const deadzone=0.05;
let ws;

function initControlSocket(){
  ws=new WebSocket(`ws://${window.location.hostname}:9090`);
  const msg=document.getElementById("statusMsg");
  ws.onopen=()=>{msg.textContent="🟢 控制已连接";msg.style.color="#00ff88";};
  ws.onclose=()=>{msg.textContent="🔴 控制断开";msg.style.color="#ff4444";};
  ws.onerror=()=>{msg.textContent="⚠️ 控制连接异常";msg.style.color="#ff8844";};
}

function startCalibration(){
  calibActive=true;
  document.getElementById("calibMsg").textContent="⏳ 正在记录极值，请持续转动/踩下各踏板...";
  setTimeout(()=>{calibActive=false;document.getElementById("calibMsg").textContent="✅ 完成，点击“确认并进入监控”";},5000);
}
function resetCalibration(){
  calibData={steerMin:1,steerMax:-1,throttleMin:1,throttleMax:-1,brakeMin:1,brakeMax:-1};
  document.getElementById("calibMsg").textContent="已重置，请重新开始校准";
}
function confirmCalibration(){
  calibrated=true;
  document.getElementById("calibrationPanel").classList.add("hidden");
  document.getElementById("mainContainer").classList.remove("hidden");
  document.getElementById("settings").classList.remove("hidden");
  setTimeout(()=>{ initWebRTC(); initThree(); bindSettings(); }, 150); // 等布局稳定再初始化
}

window.addEventListener("gamepadconnected",(e)=>{
  gamepadIndex=e.gamepad.index;
  document.getElementById("g29Status").textContent=`🎮 已连接：${e.gamepad.id}`;
  requestAnimationFrame(updateGamepad);
});
window.addEventListener("gamepaddisconnected",()=>{
  gamepadIndex=null;
  document.getElementById("g29Status").textContent="❌ 方向盘断开";
});

function normalize(v,min,max){if(max-min<0.01)return 0;let n=(v-min)/(max-min);return Math.max(0,Math.min(1,n));}
function applyDeadzone(x,d){if(Math.abs(x)<d)return 0;return (x>0)?(x-d)/(1-d):(x+d)/(1-d);}

function updateGamepad(){
  if(gamepadIndex===null) return;
  const gp=navigator.getGamepads()[gamepadIndex]; if(!gp) return;

  let steering=gp.axes[0];
  let throttle=(1-gp.axes[2])/2;
  let brake=(1-gp.axes[3])/2;

  if(calibActive){
    calibData.steerMin=Math.min(calibData.steerMin,steering);
    calibData.steerMax=Math.max(calibData.steerMax,steering);
    calibData.throttleMin=Math.min(calibData.throttleMin,throttle);
    calibData.throttleMax=Math.max(calibData.throttleMax,throttle);
    calibData.brakeMin=Math.min(calibData.brakeMin,brake);
    calibData.brakeMax=Math.max(calibData.brakeMax,brake);
  }

  const steerNorm=(steering-calibData.steerMin)/(calibData.steerMax-calibData.steerMin)*2-1;
  const throttleNorm=normalize(throttle,calibData.throttleMin,calibData.throttleMax);
  const brakeNorm=normalize(brake,calibData.brakeMin,calibData.brakeMax);

  const steerFiltered=applyDeadzone(steerNorm,deadzone);
  const alpha=0.15; // 平滑系数（越大越灵敏）
  const targetLinear=throttleNorm-brakeNorm;
  const targetAngular=-steerFiltered; // 如需反向，改为 +steerFiltered

  smooth.linear=smooth.linear*(1-alpha)+targetLinear*alpha;
  smooth.angular=smooth.angular*(1-alpha)+targetAngular*alpha;

  // 更新校准UI
  document.getElementById("steerVal").textContent=smooth.angular.toFixed(2);
  document.getElementById("throttleVal").textContent=throttleNorm.toFixed(2);
  document.getElementById("brakeVal").textContent=brakeNorm.toFixed(2);
  document.getElementById("steerBar").style.width=`${50+smooth.angular*50}%`;
  document.getElementById("throttleBar").style.width=`${throttleNorm*100}%`;
  document.getElementById("brakeBar").style.width=`${brakeNorm*100}%`;

  // 驱动 3D 车辆
  updateBusHeading(smooth.angular, smooth.linear);

  // 发送 ROS2 指令
  if(calibrated && ws && ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({type:"drive",linear:smooth.linear,angular:smooth.angular}));
  }

  requestAnimationFrame(updateGamepad);
}

/* ====================== WebRTC 播放（保持你的接口） ====================== */
const cameras=[
  {id:1,name:'CameraFrontLeft',stream:'CameraFrontLeft'},
  {id:2,name:'CameraRear',stream:'CameraRear'},
  {id:3,name:'CameraFrontRight',stream:'CameraFrontRight'},
  {id:4,name:'CameraFront',stream:'CameraFront'}
];

async function initWebRTC(){ for(const cam of cameras){ await initPlayer(cam); } }
async function initPlayer(cam){
  const video=document.getElementById(`video-${cam.id}`);
  try{
    const pc=new RTCPeerConnection();
    pc.ontrack=e=>{ video.srcObject = e.streams[0]; };
    pc.addTransceiver("video",{direction:"recvonly"});
    const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
    const api=`http://${window.location.hostname}:1985/rtc/v1/play/`;
    const streamurl=`webrtc://${window.location.hostname}/live/${cam.stream}`;
    const res=await fetch(api,{method:"POST",body:JSON.stringify({api,streamurl,sdp:offer.sdp})});
    const data=await res.json();
    await pc.setRemoteDescription({type:"answer",sdp:data.sdp});
  }catch(err){ console.error(cam.name,"WebRTC error",err); }
}

/* ====================== Three.js 3D Shuttle（参数化） ====================== */
let scene, camera3d, renderer, busGroup, wheels=[], materials={}, headlightL, headlightR;
let params = {
  bodyColor: 0xffffff,
  trimColor: 0x00ff88,
  track: 1.6,          // 轮距（左右轮中心距）
  wheelbase: 2.6,      // 轴距（前后轮中心距）
  maxSteerDeg: 30,     // 可视化最大转角
  beamMode: 'narrow'   // 'narrow' | 'wide'
};

function bindSettings(){
  const toHex = (v)=> parseInt(v.replace('#','0x'));
  bodyColor.oninput    = ()=>{ params.bodyColor = toHex(bodyColor.value);   if(materials.body) materials.body.color.set(params.bodyColor); };
  trimColor.oninput    = ()=>{ params.trimColor = toHex(trimColor.value);   if(materials.trim) materials.trim.color.set(params.trimColor); };
  track.oninput        = ()=>{ params.track = parseFloat(track.value)||1.6; updateWheelPositions(); };
  wheelbase.oninput    = ()=>{ params.wheelbase = parseFloat(wheelbase.value)||2.6; updateWheelPositions(); };
  maxSteerDeg.oninput  = ()=>{ params.maxSteerDeg = parseFloat(maxSteerDeg.value)||30; };
  beamMode.onchange    = ()=>{ params.beamMode = beamMode.value; updateHeadlightShape(); };
}

function initThree(){
  const container=document.getElementById('three-container');
  const w=container.clientWidth, h=container.clientHeight;

  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x0a0e27);

  camera3d=new THREE.PerspectiveCamera(45, w/h, 0.1, 100);
  camera3d.position.set(0,3.2,6.5);
  camera3d.lookAt(0,1.0,0);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(w,h);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  container.appendChild(renderer.domElement);

  // 光
  scene.add(new THREE.AmbientLight(0xffffff,0.35));
  const sun=new THREE.DirectionalLight(0xffffff,0.7);
  sun.position.set(5,8,4); scene.add(sun);

  // 地
  const ground=new THREE.Mesh(
    new THREE.CircleGeometry(8,64),
    new THREE.MeshStandardMaterial({color:0x0b122e, roughness:0.9})
  );
  ground.rotation.x=-Math.PI/2; scene.add(ground);

  // 车组
  busGroup=new THREE.Group(); scene.add(busGroup);

  // 材质
  materials.body=new THREE.MeshStandardMaterial({color:params.bodyColor, metalness:0.1, roughness:0.6});
  materials.trim=new THREE.MeshStandardMaterial({color:params.trimColor, metalness:0.3, roughness:0.4, emissive:0x003322, emissiveIntensity:0.35});
  const glassMat=new THREE.MeshPhysicalMaterial({color:0x88aaff, roughness:0.1, transmission:0.4, transparent:true});

  // 车身
  const body=new THREE.Mesh(new THREE.BoxGeometry(3.8,1.6,1.6), materials.body);
  body.position.y=1.0; busGroup.add(body);

  const roof=new THREE.Mesh(new THREE.BoxGeometry(3.6,0.3,1.5), materials.body);
  roof.position.set(0,1.55,0); busGroup.add(roof);

  const windshield=new THREE.Mesh(new THREE.PlaneGeometry(1.5,0.8), glassMat);
  windshield.position.set(1.95,1.2,0);
  windshield.rotation.y=-Math.PI/2.1; busGroup.add(windshield);

  const windowStripL=new THREE.Mesh(new THREE.BoxGeometry(3.0,0.7,0.05), glassMat);
  windowStripL.position.set(0,1.25, 0.8); busGroup.add(windowStripL);
  const windowStripR=windowStripL.clone(); windowStripR.position.z=-0.8; busGroup.add(windowStripR);

  const trim=new THREE.Mesh(new THREE.BoxGeometry(3.8,0.2,1.6), materials.trim);
  trim.position.set(0,0.5,0); busGroup.add(trim);

  // 轮子
  const wheelMat=new THREE.MeshStandardMaterial({color:0x222222, metalness:0.2, roughness:0.6});
  function makeWheel(){ const w=new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.35,0.3,24), wheelMat); w.rotation.z=Math.PI/2; w.position.y=0.5; return w; }
  wheels=[makeWheel(), makeWheel(), makeWheel(), makeWheel()];
  wheels.forEach(w=>busGroup.add(w));
  updateWheelPositions();

  // 大灯
  const headMat=new THREE.MeshStandardMaterial({color:0xffffcc, emissive:0xffffcc, emissiveIntensity:1.2});
  const lampL=new THREE.Mesh(new THREE.CircleGeometry(0.12,24), headMat);
  const lampR=lampL.clone();
  lampL.position.set(1.95,0.95, 0.35); lampR.position.set(1.95,0.95,-0.35);
  lampL.rotation.y=-Math.PI/2; lampR.rotation.y=-Math.PI/2; busGroup.add(lampL); busGroup.add(lampR);

  headlightL=new THREE.SpotLight(0xffffdd, 1.2, 12, Math.PI/10, 0.25, 1.2);
  headlightR=new THREE.SpotLight(0xffffdd, 1.2, 12, Math.PI/10, 0.25, 1.2);
  headlightL.position.set(1.7,0.95, 0.35);
  headlightR.position.set(1.7,0.95,-0.35);
  scene.add(headlightL, headlightR);
  headlightL.target=new THREE.Object3D();
  headlightR.target=new THREE.Object3D();
  scene.add(headlightL.target, headlightR.target);
  updateHeadlightShape(); // 根据 beamMode 设置角度等

  // 自适应
  window.addEventListener('resize', ()=>{
    const w=container.clientWidth, h=container.clientHeight;
    camera3d.aspect=w/h; camera3d.updateProjectionMatrix();
    renderer.setSize(w,h);
  });

  const tick=()=>{ renderer.render(scene,camera3d); requestAnimationFrame(tick); };
  tick();
}

function updateWheelPositions(){
  if(!wheels.length) return;
  const t = params.track/2;      // 半轮距
  const wb = params.wheelbase/2; // 半轴距
  // 顺序：前左、前右、后左、后右
  wheels[0].position.set( wb,0.5,  t);
  wheels[1].position.set( wb,0.5, -t);
  wheels[2].position.set(-wb,0.5,  t);
  wheels[3].position.set(-wb,0.5, -t);
}

function updateHeadlightShape(){
  const narrow = (params.beamMode === 'narrow');
  const angle = narrow ? Math.PI/10 : Math.PI/6; // 光束角
  const dist  = narrow ? 12 : 9;
  const penumbra = narrow ? 0.25 : 0.35;
  [headlightL, headlightR].forEach(s=>{
    s.angle = angle; s.distance = dist; s.penumbra = penumbra;
  });
}

function updateBusHeading(normYaw, linear){
  if(!busGroup || !headlightL || !headlightR) return;
  const maxRad = THREE.MathUtils.degToRad(params.maxSteerDeg);
  const yaw = maxRad * (normYaw || 0);
  busGroup.rotation.y = yaw;

  // 调整灯光目标点：随转向偏转
  const baseX=4, baseY=0.85, baseZ=0.35;
  const offset = Math.tan(yaw) * 2.0;
  headlightL.target.position.set(baseX, baseY,  baseZ + offset);
  headlightR.target.position.set(baseX, baseY, -baseZ + offset);

  // 亮度随速度微增
  const speed = Math.abs(linear || 0);
  const baseI = 1.2;
  headlightL.intensity = baseI + speed * 0.4;
  headlightR.intensity = baseI + speed * 0.4;
}

/* ====================== 启动 ====================== */
window.addEventListener("DOMContentLoaded",()=>{
  initControlSocket();
});
</script>
</body>
</html>
