<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebRTC + G29 + 3D Shuttle (Adaptive)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  /* ç»Ÿä¸€å››ä¸ªç›¸æœº tile çš„å°ºå¯¸ï¼Œè‡ªé€‚åº”ï¼šæœ€å°280pxï¼Œå¸¸è§„å è§†å£å®½åº¦çš„30%ï¼Œæœ€å¤§540px */
  --tile: clamp(280px, 30vw, 540px);
  --center-scale: 0.75; /* ä¸­é—´è½¦è¾†ç¨å°ä¸€ç‚¹ */
}

*{margin:0;padding:0;box-sizing:border-box;}
body{
  background:linear-gradient(135deg,#0a0e27 0%,#1a1e35 100%);
  color:white;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  min-height:100vh;display:flex;flex-direction:column;align-items:center;
}
.header{padding:18px 12px;text-align:center;}
h1{color:#00ff88;text-shadow:0 0 15px rgba(0,255,136,0.4);font-size:clamp(20px,2.2vw,28px);}
.subtitle{color:#9aa; font-size:clamp(12px,1.2vw,14px);}
.hidden{display:none;}

/* â€”â€” æ ¡å‡†å¡ç‰‡ â€”â€” */
.control-panel{
  margin-top:20px;width:min(92vw,480px);text-align:center;
  background:rgba(255,255,255,0.05);
  padding:18px;border-radius:12px;
  border:1px solid rgba(255,255,255,0.12);
  box-shadow:0 6px 24px rgba(0,0,0,0.20);
}
.control-panel h3{color:#00ff88;margin-bottom:8px;}
.bar-bg{background:rgba(255,255,255,0.12);border-radius:6px;margin:6px 0;height:10px;}
.bar{height:10px;background:#00ff88;border-radius:6px;transition:width 0.05s linear;}
button{
  margin:6px 6px;padding:9px 16px;border:none;border-radius:8px;cursor:pointer;
  background:rgba(255,255,255,0.1);color:#fff;backdrop-filter:blur(6px);
}
button:hover{background:#00ff88;color:#000;}
#statusMsg{margin-top:10px;color:#bbb;}

/* â€”â€” ä¸»å¸ƒå±€ï¼šç”¨ 3x3 ç½‘æ ¼å±…ä¸­æ’å¸ƒ â€”â€” */
#mainContainer{
  width:100%;
  display:grid;
  place-items:center;         /* ç½‘æ ¼å•å…ƒå†…å®¹å±…ä¸­ */
  grid-template-columns: 1fr auto 1fr;
  grid-template-rows:    1fr auto 1fr;
  gap:min(1.4vw,16px);
  padding: min(2vw,20px);
}

/* å››ä¸ªç›¸æœºå’Œä¸­é—´ 3D å—éƒ½æ”¾ä¸€ä¸ª .slot é‡Œï¼Œslot è´Ÿè´£å±…ä¸­ï¼Œå†…éƒ¨ .tile è´Ÿè´£ç»Ÿä¸€å°ºå¯¸ */
.slot{display:flex;align-items:center;justify-content:center;}

.tile{
  width:var(--tile);
  aspect-ratio:16/9;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:12px; overflow:hidden;
  box-shadow:0 6px 24px rgba(0,0,0,0.20);
  display:flex;flex-direction:column;
}
.tile-header{
  padding:6px 10px;background:rgba(0,0,0,0.45);
  border-bottom:1px solid #00ff88;font-size:0.95em;
}
.tile-body{flex:1;display:flex;align-items:center;justify-content:center;background:#000;}

video{width:100%;height:100%;object-fit:contain;background:#000;}

/* ä¸­é—´ three.js */
#three-container{
  width:calc(var(--tile)*var(--center-scale));
  height:calc(var(--tile)*var(--center-scale)*0.6);  /* æ›´æ‰ä¸€ç‚¹ï¼Œçªå‡ºå››è·¯è§†é¢‘ */
  background:rgba(10,14,39,0.6);
  border:1px dashed rgba(0,255,136,0.25);
  border-radius:12px; overflow:hidden;
}

/* â€”â€” å‚æ•°é¢æ¿ï¼ˆå¯æ”¶èµ·ï¼‰ â€”â€” */
#settings{
  margin:12px auto; width:min(92vw,960px); 
  background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12);
  border-radius:12px; padding:12px;
}
#settings h4{margin:0 0 8px 0; color:#00ff88;}
.settings-grid{
  display:grid; gap:10px;
  grid-template-columns: repeat(6, minmax(120px, 1fr));
}
.settings-grid label{font-size:12px;color:#cfd;}
.settings-grid input[type="color"], .settings-grid input[type="number"], .settings-grid select{
  width:100%; padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.15);
  background:rgba(0,0,0,0.35); color:#fff;
}
@media (max-width: 1100px){
  .settings-grid{ grid-template-columns: repeat(3, minmax(120px, 1fr)); }
}
@media (max-width: 600px){
  .settings-grid{ grid-template-columns: repeat(2, minmax(120px, 1fr)); }
}

/* â€”â€” è‡ªé€‚åº”æ•´ä½“å¤–è¾¹è· â€”â€” */
.container-pad { padding: min(2vw, 20px); }
</style>
</head>
<body>
  <div class="header">
    <h1>ğŸ›°ï¸ WebRTC + Logitech G29 + 3D Shuttle</h1>
    <p class="subtitle">å››è·¯ç›¸æœºç­‰å°ºå¯¸ | ä¸­å¿ƒ 3D è½¦è¾†ç¨å° | è‡ªé€‚åº”å¸ƒå±€</p>
  </div>

  <!-- ğŸ® æ ¡å‡†é¢æ¿ -->
  <div id="calibrationPanel" class="control-panel">
    <h3>ğŸ® Logitech G29 æ ¡å‡†</h3>
    <div id="g29Status">ç­‰å¾…è¿æ¥ G29 ...ï¼ˆæŒ‰ä»»æ„æŒ‰é”®å”¤é†’ï¼‰</div>
    <div id="calibMsg" style="margin-top:4px;">å·¦å³æ‰“æ»¡æ–¹å‘ã€æ²¹é—¨åˆ¹è½¦è¸©åˆ°åº•ï¼Œç„¶åç‚¹å¼€å§‹</div>
    <div style="margin-top:8px;">
      <button onclick="startCalibration()">å¼€å§‹æ ¡å‡†</button>
      <button onclick="confirmCalibration()">ç¡®è®¤å¹¶è¿›å…¥ç›‘æ§</button>
      <button onclick="resetCalibration()">é‡ç½®</button>
    </div>
    <div style="margin-top:12px;text-align:left;">
      <div>Steering <span id="steerVal">0</span></div>
      <div class="bar-bg"><div id="steerBar" class="bar" style="width:50%"></div></div>
      <div>Throttle <span id="throttleVal">0</span></div>
      <div class="bar-bg"><div id="throttleBar" class="bar" style="width:0%"></div></div>
      <div>Brake <span id="brakeVal">0</span></div>
      <div class="bar-bg"><div id="brakeBar" class="bar" style="width:0%"></div></div>
    </div>
    <p id="statusMsg">æ­£åœ¨è¿æ¥æ§åˆ¶æœåŠ¡å™¨...</p>
  </div>

  <!-- âš™ï¸ è½¦è¾†å‚æ•°è®¾ç½®ï¼ˆè¿›å…¥ç›‘æ§åå¯ç”¨ï¼‰ -->
  <div id="settings" class="hidden">
    <h4>âš™ï¸ è½¦è¾†å‚æ•°è®¾ç½®</h4>
    <div class="settings-grid">
      <div><label>è½¦èº«é¢œè‰²</label><input type="color" id="bodyColor" value="#ffffff"></div>
      <div><label>é¥°æ¡é¢œè‰²</label><input type="color" id="trimColor" value="#00ff88"></div>
      <div><label>è½®è· Track (m)</label><input type="number" id="track" step="0.1" value="1.6"></div>
      <div><label>è½´è· Wheelbase (m)</label><input type="number" id="wheelbase" step="0.1" value="2.6"></div>
      <div><label>æœ€å¤§è½¬è§’ (Â°)</label><input type="number" id="maxSteerDeg" step="1" value="30"></div>
      <div>
        <label>å¤§ç¯æ¨¡å¼</label>
        <select id="beamMode">
          <option value="narrow" selected>çª„å…‰æŸ</option>
          <option value="wide">å®½å…‰æŸ</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ğŸ–¼ ä¸»å¸ƒå±€ï¼ˆå››è·¯ç›¸æœºç­‰å°ºå¯¸ + ä¸­é—´ 3D ç¨å°ï¼‰ -->
  <div id="mainContainer" class="hidden container-pad">
    <!-- é¡¶éƒ¨ï¼šFront -->
    <div class="slot" style="grid-row:1; grid-column:2;">
      <div class="tile">
        <div class="tile-header">Front Camera</div>
        <div class="tile-body"><video id="video-4" autoplay playsinline muted></video></div>
      </div>
    </div>

    <!-- ä¸­é—´å·¦ï¼šFrontLeft -->
    <div class="slot" style="grid-row:2; grid-column:1;">
      <div class="tile">
        <div class="tile-header">FrontLeft Camera</div>
        <div class="tile-body"><video id="video-1" autoplay playsinline muted></video></div>
      </div>
    </div>

    <!-- ä¸­é—´ï¼šThree.js Shuttle Busï¼ˆå°ºå¯¸ç¨å°ï¼‰ -->
    <div class="slot" style="grid-row:2; grid-column:2;">
      <div id="three-container"></div>
    </div>

    <!-- ä¸­é—´å³ï¼šFrontRight -->
    <div class="slot" style="grid-row:2; grid-column:3;">
      <div class="tile">
        <div class="tile-header">FrontRight Camera</div>
        <div class="tile-body"><video id="video-3" autoplay playsinline muted></video></div>
      </div>
    </div>

    <!-- åº•éƒ¨ï¼šRear -->
    <div class="slot" style="grid-row:3; grid-column:2;">
      <div class="tile">
        <div class="tile-header">Rear Camera</div>
        <div class="tile-body"><video id="video-2" autoplay playsinline muted></video></div>
      </div>
    </div>
  </div>

<!-- Three.jsï¼ˆéæ¨¡å—ç‰ˆï¼Œå½“å‰å…¼å®¹ï¼›æœªæ¥å¯æ¢ ESMï¼‰ -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

<script>
/* ====================== G29 æ§åˆ¶ä¸æ ¡å‡† ====================== */
let gamepadIndex=null, calibActive=false, calibrated=false;
let calibData={steerMin:1,steerMax:-1,throttleMin:1,throttleMax:-1,brakeMin:1,brakeMax:-1};
let smooth={linear:0,angular:0};
const deadzone=0.05;
let ws;

function initControlSocket(){
  ws=new WebSocket(`ws://${window.location.hostname}:9090`);
  const msg=document.getElementById("statusMsg");
  ws.onopen=()=>{msg.textContent="ğŸŸ¢ æ§åˆ¶å·²è¿æ¥";msg.style.color="#00ff88";};
  ws.onclose=()=>{msg.textContent="ğŸ”´ æ§åˆ¶æ–­å¼€";msg.style.color="#ff4444";};
  ws.onerror=()=>{msg.textContent="âš ï¸ æ§åˆ¶è¿æ¥å¼‚å¸¸";msg.style.color="#ff8844";};
}

function startCalibration(){
  calibActive=true;
  document.getElementById("calibMsg").textContent="â³ æ­£åœ¨è®°å½•æå€¼ï¼Œè¯·æŒç»­è½¬åŠ¨/è¸©ä¸‹å„è¸æ¿...";
  setTimeout(()=>{calibActive=false;document.getElementById("calibMsg").textContent="âœ… å®Œæˆï¼Œç‚¹å‡»â€œç¡®è®¤å¹¶è¿›å…¥ç›‘æ§â€";},5000);
}
function resetCalibration(){
  calibData={steerMin:1,steerMax:-1,throttleMin:1,throttleMax:-1,brakeMin:1,brakeMax:-1};
  document.getElementById("calibMsg").textContent="å·²é‡ç½®ï¼Œè¯·é‡æ–°å¼€å§‹æ ¡å‡†";
}
function confirmCalibration(){
  calibrated=true;
  document.getElementById("calibrationPanel").classList.add("hidden");
  document.getElementById("mainContainer").classList.remove("hidden");
  document.getElementById("settings").classList.remove("hidden");
  setTimeout(()=>{ initWebRTC(); initThree(); bindSettings(); }, 150); // ç­‰å¸ƒå±€ç¨³å®šå†åˆå§‹åŒ–
}

window.addEventListener("gamepadconnected",(e)=>{
  gamepadIndex=e.gamepad.index;
  document.getElementById("g29Status").textContent=`ğŸ® å·²è¿æ¥ï¼š${e.gamepad.id}`;
  requestAnimationFrame(updateGamepad);
});
window.addEventListener("gamepaddisconnected",()=>{
  gamepadIndex=null;
  document.getElementById("g29Status").textContent="âŒ æ–¹å‘ç›˜æ–­å¼€";
});

function normalize(v,min,max){if(max-min<0.01)return 0;let n=(v-min)/(max-min);return Math.max(0,Math.min(1,n));}
function applyDeadzone(x,d){if(Math.abs(x)<d)return 0;return (x>0)?(x-d)/(1-d):(x+d)/(1-d);}

function updateGamepad(){
  if(gamepadIndex===null) return;
  const gp=navigator.getGamepads()[gamepadIndex]; if(!gp) return;

  let steering=gp.axes[0];
  let throttle=(1-gp.axes[2])/2;
  let brake=(1-gp.axes[3])/2;

  if(calibActive){
    calibData.steerMin=Math.min(calibData.steerMin,steering);
    calibData.steerMax=Math.max(calibData.steerMax,steering);
    calibData.throttleMin=Math.min(calibData.throttleMin,throttle);
    calibData.throttleMax=Math.max(calibData.throttleMax,throttle);
    calibData.brakeMin=Math.min(calibData.brakeMin,brake);
    calibData.brakeMax=Math.max(calibData.brakeMax,brake);
  }

  const steerNorm=(steering-calibData.steerMin)/(calibData.steerMax-calibData.steerMin)*2-1;
  const throttleNorm=normalize(throttle,calibData.throttleMin,calibData.throttleMax);
  const brakeNorm=normalize(brake,calibData.brakeMin,calibData.brakeMax);

  const steerFiltered=applyDeadzone(steerNorm,deadzone);
  const alpha=0.15; // å¹³æ»‘ç³»æ•°ï¼ˆè¶Šå¤§è¶Šçµæ•ï¼‰
  const targetLinear=throttleNorm-brakeNorm;
  const targetAngular=-steerFiltered; // å¦‚éœ€åå‘ï¼Œæ”¹ä¸º +steerFiltered

  smooth.linear=smooth.linear*(1-alpha)+targetLinear*alpha;
  smooth.angular=smooth.angular*(1-alpha)+targetAngular*alpha;

  // æ›´æ–°æ ¡å‡†UI
  document.getElementById("steerVal").textContent=smooth.angular.toFixed(2);
  document.getElementById("throttleVal").textContent=throttleNorm.toFixed(2);
  document.getElementById("brakeVal").textContent=brakeNorm.toFixed(2);
  document.getElementById("steerBar").style.width=`${50+smooth.angular*50}%`;
  document.getElementById("throttleBar").style.width=`${throttleNorm*100}%`;
  document.getElementById("brakeBar").style.width=`${brakeNorm*100}%`;

  // é©±åŠ¨ 3D è½¦è¾†
  updateBusHeading(smooth.angular, smooth.linear);

  // å‘é€ ROS2 æŒ‡ä»¤
  if(calibrated && ws && ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({type:"drive",linear:smooth.linear,angular:smooth.angular}));
  }

  requestAnimationFrame(updateGamepad);
}

/* ====================== WebRTC æ’­æ”¾ï¼ˆä¿æŒä½ çš„æ¥å£ï¼‰ ====================== */
const cameras=[
  {id:1,name:'CameraFrontLeft',stream:'CameraFrontLeft'},
  {id:2,name:'CameraRear',stream:'CameraRear'},
  {id:3,name:'CameraFrontRight',stream:'CameraFrontRight'},
  {id:4,name:'CameraFront',stream:'CameraFront'}
];

async function initWebRTC(){ for(const cam of cameras){ await initPlayer(cam); } }
async function initPlayer(cam){
  const video=document.getElementById(`video-${cam.id}`);
  try{
    const pc=new RTCPeerConnection();
    pc.ontrack=e=>{ video.srcObject = e.streams[0]; };
    pc.addTransceiver("video",{direction:"recvonly"});
    const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
    const api=`http://${window.location.hostname}:1985/rtc/v1/play/`;
    const streamurl=`webrtc://${window.location.hostname}/live/${cam.stream}`;
    const res=await fetch(api,{method:"POST",body:JSON.stringify({api,streamurl,sdp:offer.sdp})});
    const data=await res.json();
    await pc.setRemoteDescription({type:"answer",sdp:data.sdp});
  }catch(err){ console.error(cam.name,"WebRTC error",err); }
}

/* ====================== Three.js 3D Shuttleï¼ˆå‚æ•°åŒ–ï¼‰ ====================== */
let scene, camera3d, renderer, busGroup, wheels=[], materials={}, headlightL, headlightR;
let params = {
  bodyColor: 0xffffff,
  trimColor: 0x00ff88,
  track: 1.6,          // è½®è·ï¼ˆå·¦å³è½®ä¸­å¿ƒè·ï¼‰
  wheelbase: 2.6,      // è½´è·ï¼ˆå‰åè½®ä¸­å¿ƒè·ï¼‰
  maxSteerDeg: 30,     // å¯è§†åŒ–æœ€å¤§è½¬è§’
  beamMode: 'narrow'   // 'narrow' | 'wide'
};

function bindSettings(){
  const toHex = (v)=> parseInt(v.replace('#','0x'));
  bodyColor.oninput    = ()=>{ params.bodyColor = toHex(bodyColor.value);   if(materials.body) materials.body.color.set(params.bodyColor); };
  trimColor.oninput    = ()=>{ params.trimColor = toHex(trimColor.value);   if(materials.trim) materials.trim.color.set(params.trimColor); };
  track.oninput        = ()=>{ params.track = parseFloat(track.value)||1.6; updateWheelPositions(); };
  wheelbase.oninput    = ()=>{ params.wheelbase = parseFloat(wheelbase.value)||2.6; updateWheelPositions(); };
  maxSteerDeg.oninput  = ()=>{ params.maxSteerDeg = parseFloat(maxSteerDeg.value)||30; };
  beamMode.onchange    = ()=>{ params.beamMode = beamMode.value; updateHeadlightShape(); };
}

function initThree(){
  const container=document.getElementById('three-container');
  const w=container.clientWidth, h=container.clientHeight;

  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x0a0e27);

  camera3d=new THREE.PerspectiveCamera(45, w/h, 0.1, 100);
  camera3d.position.set(0,3.2,6.5);
  camera3d.lookAt(0,1.0,0);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(w,h);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  container.appendChild(renderer.domElement);

  // å…‰
  scene.add(new THREE.AmbientLight(0xffffff,0.35));
  const sun=new THREE.DirectionalLight(0xffffff,0.7);
  sun.position.set(5,8,4); scene.add(sun);

  // åœ°
  const ground=new THREE.Mesh(
    new THREE.CircleGeometry(8,64),
    new THREE.MeshStandardMaterial({color:0x0b122e, roughness:0.9})
  );
  ground.rotation.x=-Math.PI/2; scene.add(ground);

  // è½¦ç»„
  busGroup=new THREE.Group(); scene.add(busGroup);

  // æè´¨
  materials.body=new THREE.MeshStandardMaterial({color:params.bodyColor, metalness:0.1, roughness:0.6});
  materials.trim=new THREE.MeshStandardMaterial({color:params.trimColor, metalness:0.3, roughness:0.4, emissive:0x003322, emissiveIntensity:0.35});
  const glassMat=new THREE.MeshPhysicalMaterial({color:0x88aaff, roughness:0.1, transmission:0.4, transparent:true});

  // è½¦èº«
  const body=new THREE.Mesh(new THREE.BoxGeometry(3.8,1.6,1.6), materials.body);
  body.position.y=1.0; busGroup.add(body);

  const roof=new THREE.Mesh(new THREE.BoxGeometry(3.6,0.3,1.5), materials.body);
  roof.position.set(0,1.55,0); busGroup.add(roof);

  const windshield=new THREE.Mesh(new THREE.PlaneGeometry(1.5,0.8), glassMat);
  windshield.position.set(1.95,1.2,0);
  windshield.rotation.y=-Math.PI/2.1; busGroup.add(windshield);

  const windowStripL=new THREE.Mesh(new THREE.BoxGeometry(3.0,0.7,0.05), glassMat);
  windowStripL.position.set(0,1.25, 0.8); busGroup.add(windowStripL);
  const windowStripR=windowStripL.clone(); windowStripR.position.z=-0.8; busGroup.add(windowStripR);

  const trim=new THREE.Mesh(new THREE.BoxGeometry(3.8,0.2,1.6), materials.trim);
  trim.position.set(0,0.5,0); busGroup.add(trim);

  // è½®å­
  const wheelMat=new THREE.MeshStandardMaterial({color:0x222222, metalness:0.2, roughness:0.6});
  function makeWheel(){ const w=new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.35,0.3,24), wheelMat); w.rotation.z=Math.PI/2; w.position.y=0.5; return w; }
  wheels=[makeWheel(), makeWheel(), makeWheel(), makeWheel()];
  wheels.forEach(w=>busGroup.add(w));
  updateWheelPositions();

  // å¤§ç¯
  const headMat=new THREE.MeshStandardMaterial({color:0xffffcc, emissive:0xffffcc, emissiveIntensity:1.2});
  const lampL=new THREE.Mesh(new THREE.CircleGeometry(0.12,24), headMat);
  const lampR=lampL.clone();
  lampL.position.set(1.95,0.95, 0.35); lampR.position.set(1.95,0.95,-0.35);
  lampL.rotation.y=-Math.PI/2; lampR.rotation.y=-Math.PI/2; busGroup.add(lampL); busGroup.add(lampR);

  headlightL=new THREE.SpotLight(0xffffdd, 1.2, 12, Math.PI/10, 0.25, 1.2);
  headlightR=new THREE.SpotLight(0xffffdd, 1.2, 12, Math.PI/10, 0.25, 1.2);
  headlightL.position.set(1.7,0.95, 0.35);
  headlightR.position.set(1.7,0.95,-0.35);
  scene.add(headlightL, headlightR);
  headlightL.target=new THREE.Object3D();
  headlightR.target=new THREE.Object3D();
  scene.add(headlightL.target, headlightR.target);
  updateHeadlightShape(); // æ ¹æ® beamMode è®¾ç½®è§’åº¦ç­‰

  // è‡ªé€‚åº”
  window.addEventListener('resize', ()=>{
    const w=container.clientWidth, h=container.clientHeight;
    camera3d.aspect=w/h; camera3d.updateProjectionMatrix();
    renderer.setSize(w,h);
  });

  const tick=()=>{ renderer.render(scene,camera3d); requestAnimationFrame(tick); };
  tick();
}

function updateWheelPositions(){
  if(!wheels.length) return;
  const t = params.track/2;      // åŠè½®è·
  const wb = params.wheelbase/2; // åŠè½´è·
  // é¡ºåºï¼šå‰å·¦ã€å‰å³ã€åå·¦ã€åå³
  wheels[0].position.set( wb,0.5,  t);
  wheels[1].position.set( wb,0.5, -t);
  wheels[2].position.set(-wb,0.5,  t);
  wheels[3].position.set(-wb,0.5, -t);
}

function updateHeadlightShape(){
  const narrow = (params.beamMode === 'narrow');
  const angle = narrow ? Math.PI/10 : Math.PI/6; // å…‰æŸè§’
  const dist  = narrow ? 12 : 9;
  const penumbra = narrow ? 0.25 : 0.35;
  [headlightL, headlightR].forEach(s=>{
    s.angle = angle; s.distance = dist; s.penumbra = penumbra;
  });
}

function updateBusHeading(normYaw, linear){
  if(!busGroup || !headlightL || !headlightR) return;
  const maxRad = THREE.MathUtils.degToRad(params.maxSteerDeg);
  const yaw = maxRad * (normYaw || 0);
  busGroup.rotation.y = yaw;

  // è°ƒæ•´ç¯å…‰ç›®æ ‡ç‚¹ï¼šéšè½¬å‘åè½¬
  const baseX=4, baseY=0.85, baseZ=0.35;
  const offset = Math.tan(yaw) * 2.0;
  headlightL.target.position.set(baseX, baseY,  baseZ + offset);
  headlightR.target.position.set(baseX, baseY, -baseZ + offset);

  // äº®åº¦éšé€Ÿåº¦å¾®å¢
  const speed = Math.abs(linear || 0);
  const baseI = 1.2;
  headlightL.intensity = baseI + speed * 0.4;
  headlightR.intensity = baseI + speed * 0.4;
}

/* ====================== å¯åŠ¨ ====================== */
window.addEventListener("DOMContentLoaded",()=>{
  initControlSocket();
});
</script>
</body>
</html>
